<!DOCTYPE HTML>
<html>
  <head>
    <title>2.009 Pink Rating Results</title>
    <link rel="stylesheet" type="text/css" href="/css/reset.css">
    <link rel="stylesheet" type="text/css" href="/css/main.css">
    <script src="https://cdn.firebase.com/js/client/1.1.2/firebase.js"></script>
    <script src="http://underscorejs.org/underscore-min.js"></script>
  </head>
  <body>
    <h1>2.009 Pink Rating Form RESULTS</h1>
    <table>
      <thead>
      <tr>
        <th>Product</th>
        <th>Complexity</th>
        <th>Pot. Impact</th>
        <th>Originality</th>
        <th>Scope</th>
        <th>Hype</th>
        <th>TOTAL</th>
      </tr>
    </thead>
    <tbody>
      <tr id='coolkeep'>
        <td>CoolKeep</td>
        <td id="coolkeep_c"></td>
        <td id="coolkeep_p"></td>
        <td id="coolkeep_o"></td>
        <td id="coolkeep_s"></td>
        <td id="coolkeep_h"></td>
        <td class='total' id="coolkeep_t"></td>
      </tr>
      <tr id='icecheck'>
        <td>IceCheck</td>
        <td id="icecheck_c"></td>
        <td id="icecheck_p"></td>
        <td id="icecheck_o"></td>
        <td id="icecheck_s"></td>
        <td id="icecheck_h"></td>
        <td class='total' id="icecheck_t"></td>
      </tr>
      <tr id='proxband'>
        <td>ProxBand</td>
        <td id="proxband_c"></td>
        <td id="proxband_p"></td>
        <td id="proxband_o"></td>
        <td id="proxband_s"></td>
        <td id="proxband_h"></td>
        <td class='total' id="proxband_t"></td>
      </tr>
      <tr id='pt'>
        <td>PT</td>
        <td id="pt_c"/></td>
        <td id="pt_p" /></td>
        <td id="pt_o" /></td>
        <td id="pt_s" /></td>
        <td id="pt_h" /></td>
        <td class='total' id="pt_t"></td>
      </tr>
    </tbody>
    </table>

    <table>
      <thead>
      <tr>
        <th>Product</th>
        <th colspan='3'>Complexity</th>
        <th colspan='3'>Pot. Impact</th>
        <th colspan='3'>Originality</th>
        <th colspan='3'>Scope</th>
        <th colspan='3'>Hype</th>
      </tr>
      <tr class='cell-row'>
        <th></th>
        <th>+1</th>
        <th>0</th>
        <th>-1</th>
        <th>+1</th>
        <th>0</th>
        <th>-1</th>
        <th>+1</th>
        <th>0</th>
        <th>-1</th>
        <th>+1</th>
        <th>0</th>
        <th>-1</th>
        <th>+1</th>
        <th>0</th>
        <th>-1</th>
    </thead>
    <tbody>
      <tr class='cell-row'>
        <td>CoolKeep</td>
        <td id="coolkeep_c_plus">0</td>
        <td id="coolkeep_c_zero">0</td>
        <td id="coolkeep_c_minus">0</td>
        <td id="coolkeep_p_plus">0</td>
        <td id="coolkeep_p_zero">0</td>
        <td id="coolkeep_p_minus">0</td>
        <td id="coolkeep_o_plus">0</td>
        <td id="coolkeep_o_zero">0</td>
        <td id="coolkeep_o_minus">0</td>
        <td id="coolkeep_s_plus">0</td>
        <td id="coolkeep_s_zero">0</td>
        <td id="coolkeep_s_minus">0</td>
        <td id="coolkeep_h_plus">0</td>
        <td id="coolkeep_h_zero">0</td>
        <td id="coolkeep_h_minus">0</td>
      </tr>
      <tr class='cell-row'>
        <td>IceCheck</td>
        <td id="icecheck_c_plus">0</td>
        <td id="icecheck_c_zero">0</td>
        <td id="icecheck_c_minus">0</td>
        <td id="icecheck_p_plus">0</td>
        <td id="icecheck_p_zero">0</td>
        <td id="icecheck_p_minus">0</td>
        <td id="icecheck_o_plus">0</td>
        <td id="icecheck_o_zero">0</td>
        <td id="icecheck_o_minus">0</td>
        <td id="icecheck_s_plus">0</td>
        <td id="icecheck_s_zero">0</td>
        <td id="icecheck_s_minus">0</td>
        <td id="icecheck_h_plus">0</td>
        <td id="icecheck_h_zero">0</td>
        <td id="icecheck_h_minus">0</td>
      </tr>
      <tr class='cell-row'>
        <td>ProxBand</td>
        <td id="proxband_c_plus">0</td>
        <td id="proxband_c_zero">0</td>
        <td id="proxband_c_minus">0</td>
        <td id="proxband_p_plus">0</td>
        <td id="proxband_p_zero">0</td>
        <td id="proxband_p_minus">0</td>
        <td id="proxband_o_plus">0</td>
        <td id="proxband_o_zero">0</td>
        <td id="proxband_o_minus">0</td>
        <td id="proxband_s_plus">0</td>
        <td id="proxband_s_zero">0</td>
        <td id="proxband_s_minus">0</td>
        <td id="proxband_h_plus">0</td>
        <td id="proxband_h_zero">0</td>
        <td id="proxband_h_minus">0</td>
      </tr>
      <tr class='cell-row'>
        <td>PT</td>
        <td id="pt_c_plus">0</td>
        <td id="pt_c_zero">0</td>
        <td id="pt_c_minus">0</td>
        <td id="pt_p_plus">0</td>
        <td id="pt_p_zero">0</td>
        <td id="pt_p_minus">0</td>
        <td id="pt_o_plus">0</td>
        <td id="pt_o_zero">0</td>
        <td id="pt_o_minus">0</td>
        <td id="pt_s_plus">0</td>
        <td id="pt_s_zero">0</td>
        <td id="pt_s_minus">0</td>
        <td id="pt_h_plus">0</td>
        <td id="pt_h_zero">0</td>
        <td id="pt_h_minus">0</td>
      </tr>
    </tbody>
    </table>

    <h2></h2>
    <script src='/js/jquery.min.js' type='text/javascript'></script>
    <script src='/js/main.js' type='text/javascript'></script>
    <script>
    $(function() {
      var ref = new Firebase('https://poofytoo.firebaseio.com/pughvote');
      var FORM_ID = 1;

      f = {};
      f.coolkeep = {};
      f.icecheck = {};
      f.proxband = {};
      f.pt = {};

      var numUsers = 0;
      ref.once('value', function(s) {
        // Tabulating Results
        var data = s.val().results;
        for (user in data) {
          if (user !== 'temp') {
            numUsers ++;
            userVote = data[user];
            for (productName in userVote) {
              for (productAttr in userVote[productName]) {
                if (f[productName][productAttr]) {
                  f[productName][productAttr] += parseFloat(userVote[productName][productAttr]);
                } else {
                  f[productName][productAttr] = parseFloat(userVote[productName][productAttr]);
                }
                var actualVal = userVote[productName][productAttr];
                var item = $('#' + productName + '_' + productAttr + '_zero');
                if (actualVal < 0) {
                  item = $('#' + productName + '_' + productAttr + '_minus');
                } else if (actualVal > 0) {
                  item = $('#' + productName + '_' + productAttr + '_plus');
                }
                var tally = parseInt(item.text());
                console.log(tally);
                item.text(tally + 1);
              }
            }
          }
        }
        // Displaying Results
        var products = ['coolkeep','icecheck','proxband','pt'];
        var results = {c: [], p: [], o: [], s: [], h: [], total: []};
        var attributes = ['c', 'p', 'o', 's', 'h'];
        for (i in products) {
          var productName = products[i];
          var total = 0;
          for (j in attributes) {
            var attributeName = attributes[j];
            var fVal = Math.round(f[productName][attributeName]/numUsers * 10) / 10;
            results[attributeName].push(fVal);
            total += fVal;
            $('#' + productName + '_' + attributeName).text(fVal)
          }
          $('#' + productName + '_t').html("<em>" + total.toFixed(1) + "</em>");
          results.total.push(total);
        }
        // For indexing
        attributes.push('total');

        var green = 'rgba(34, 144, 14, ';
        var red = 'rgba(196, 0, 0, ';
        var opacity = 0.5;
        _.each(results, function(values, attribute) {
          var idx = _.indexOf(attributes, attribute) + 2;
          var positives = _.filter(values, function(val) { return val >= 0; });
          var positiveSum = 0;
          if (positives.length > 0) {
            positiveSum = _.reduce(positives, function(memo, num) { return memo + num; });
          }
          var negatives = _.filter(values, function(val) { return val < 0; });
          var negativeSum = 0;
          if (negatives.length > 0) {
            negativeSum = _.reduce(negatives, function(memo, num) { return memo + num; });
          }
          var column = _.map(values, function(value, index) {
            return {
              product: products[index],
              result: value
            }
          });
          column = _.sortBy(column, function(value) { return value.result; });
          _.each(column, function(product, index) {
            if (product.product !== 'icecheck') {
              var cell = $('#' + product.product + ' td:nth-child(' + idx + ')');
              if (product.result >= 0) {
                var greenOpacity = 0.5 * (product.result) / positiveSum;
                cell.css('background', green + greenOpacity + ')');
                if (attribute === 'total') {
                  greenOpacity = (product.result) / positiveSum;
                  cell.css('box-shadow', '0 0 0 2px #fff inset');
                }
              } else {
                var redOpacity = 0.5 * (product.result) / negativeSum;
                cell.css('background', red + redOpacity + ')');
                if (attribute == 'total') {
                  redOpacity = (product.result) / negativeSum;
                  cell.css('box-shadow', '0 0 0 2px #fff inset');
                }
              }
            }
          });
        });
        $('h2').text('Participation: ' + numUsers)
      })
    })
    </script>
    <!-- Load any other client side scripts here. Add them in the /public/js/ folder -->
  </body>
</html>